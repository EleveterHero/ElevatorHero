using UnityEngine;
using System.Collections;
using UnityEngine.UI;
using System.Collections.Generic;

#if UNITY_EDITOR
using UnityEditor;      //!< デプロイ時にEditorスクリプトが入るとエラーになるので
#endif

public class BackSprite : MonoBehaviour {
	//背景に使用するかもしれない画像のデータ
	static Dictionary<string,Sprite> g_static_sprites = null;

	//移動処理を行うかどうか
	public bool move = false;

	//移動スピード（5.0ｆで１階を4秒ほど、画像の大きさによってプログラム側で調整）
	public float speed = 5.0f;

	//外部から階数が変更されたかどうかのフラグ
	bool m_floorchanged_from_outside = false;

	//階数
	[SerializeField]
	float m_floor = 0.0f;
	public float floor
	{
		get
		{
			return m_floor;
		}
		set
		{
			if (m_floor != value)
			{
				m_floorchanged_from_outside = true;
				m_floor = value;
			}
		}

	}
	
	//最初からの移動量の合計
	float delta_move_from_start = 0.0f;

	//前フレームからの移動量
	float delta_move = 0.0f;

	//背景のスプライトども
	GameObject[] backsprites = null;

	//ループフラグ
	public bool loop = false;


	void Awake()
	{

		//画像のロード
		if(g_static_sprites == null)
		{
		   g_static_sprites = new Dictionary<string, Sprite>();


			foreach (Sprite sp in Resources.LoadAll<Sprite>("Image/BattleBack"))
			{
				g_static_sprites.Add(sp.name, sp);
			}

		}
		//=============================


		//背景のスポーンと設定
		int i = 0;
		backsprites = new GameObject[10];

		for(int j=0;j<backsprites.Length;j++)
		{ 
			backsprites[j] = new GameObject("back" + i);
			backsprites[j].transform.SetParent(transform);

			SpriteRenderer renderer=
			backsprites[j].AddComponent<SpriteRenderer>();

			renderer.sprite = g_static_sprites["28488748"];

			backsprites[j].layer = LayerMask.NameToLayer("BackGround");
			backsprites[j].transform.localPosition = new Vector3(0.0f,i*20.0f,0.0f);
			backsprites[j].transform.localScale = new Vector3(3.0f, 3.0f, 1.0f);
			backsprites[j].SetActive(false);
			i++;
		}
		//==============================

	}



	// Use this for initialization
	void Start () {
		if (backsprites[0] != null)
		{
			backsprites[0].SetActive(true);
		}

	}

	// Update is called once per frame
	void Update()
	{

		CalcurateMove();

		CalcurateLoop();

		SetPositions();





	}

	/// <summary>
	/// 移動量と階数の計算
	/// </summary>
	void CalcurateMove()
	{
		if (!CheckFloorChanged())

		{

			if (move)
			{
				delta_move = speed * Time.deltaTime;

			}
			else
			{
				delta_move = 0.0f;
			}

			delta_move_from_start += delta_move;
			m_floor = delta_move_from_start / 20.0f;

		}
	}

	/// <summary>
	/// ループの判定と処理
	/// </summary>
	void CalcurateLoop()
	{
		if (loop)
		{
			if (backsprites[backsprites.Length - 1].transform.localPosition.y <= 0.0f)
			{
				delta_move = -delta_move_from_start;
				delta_move_from_start = 0;

			}
		}
	}

	/// <summary>
	/// 外部から階数が変更されたかどうかの判定と処理
	/// </summary>
	/// <returns>外部から変更されてたら処理してtrue</returns>
	bool CheckFloorChanged()
	{
		if (m_floorchanged_from_outside)
		{
			delta_move = -(delta_move_from_start - 20.0f * m_floor);

			delta_move_from_start = 20.0f * m_floor;
			m_floorchanged_from_outside = false;

			return true;
		}
		return false;
	}

	/// <summary>
	/// 背景画像を一括移動
	/// </summary>
	void SetPositions()
	{

		foreach (GameObject ob in backsprites)
		{
			Vector3 pos = ob.transform.localPosition;

			pos -= new Vector3(0.0f, delta_move, 0.0f);

			if (pos.y > -100 && pos.y < 100)
			{
				ob.SetActive(true);
			}
			else
			{
				ob.SetActive(false);
			}

			ob.transform.localPosition = pos;
		}
	}



	/// <summary>
	/// インスペクタービューの拡張
	/// </summary>
	//====================================================================================================


#if UNITY_EDITOR

	[CustomEditor(typeof(BackSprite))]
	public class BackSpriteEditor : Editor
	{
		public override void OnInspectorGUI()
		{

			serializedObject.Update();
			// 対象となるオブジェクト
			var backsprite = target as BackSprite;

			// プロパティ用のGUI追加
			EditorGUILayout.LabelField("ここで変更した内容は、");
			EditorGUILayout.LabelField("スプリクトにすぐに適応されます。");
			backsprite.move = EditorGUILayout.Toggle("Move", backsprite.move);
			backsprite.loop = EditorGUILayout.Toggle("Loop", backsprite.loop);
			backsprite.speed = EditorGUILayout.FloatField("Speed", backsprite.speed);
			backsprite.floor = EditorGUILayout.FloatField("Floor", backsprite.floor);


			serializedObject.ApplyModifiedProperties();
			
		}
	}


#endif






}
